import os
from fastapi import FastAPI
from pydantic import BaseModel
from tripsy.rag_engine import retrieve_and_answer

app = FastAPI()

class AskPayload(BaseModel):
    message: str
    history: list[dict] | None = None
    session_id: str | None = None

@app.get("/health")
async def health():
    return {"status": "ok"}

@app.post("/ask")
async def ask(payload: AskPayload):
    user_message = payload.message.strip()

    # Get answer from RAG engine
    # ---- Chat memory glue: fold history turns into the prompt ----
    hist = payload.history or []
    convo_lines = []
    for m in hist:
        role = (m.get("role") or "user").lower()
        content = (m.get("content") or m.get("message") or "").strip()
        if not content:
            continue
        speaker = "User" if role == "user" else "Assistant"
        convo_lines.append(f"{speaker}: {content}")
    # append the new user message
    convo_lines.append(f"User: {user_message}")
    # keep only last 12 lines to stay concise
    convo_text = "\n".join(convo_lines[-12:])

    stitched = f"""Conversation so far:
{convo_text}

Assistant, continue the conversation naturally and help the user. Avoid repeating prior text; be concise and friendly.\"\"\"

    answer = retrieve_and_answer(stitched)

    # Fallbacks if model/web doesn’t answer well
    if not answer or "does not mention" in answer.lower() or "no information" in answer.lower():
        fallback_answers = {
            "chandigarh": "The best sector to shop in Chandigarh is Sector 17, known as the city’s main commercial hub with markets, boutiques, and malls.",
            "telephone": "Alexander Graham Bell is credited with inventing the first practical telephone in 1876.",
            "square root of 144": "The square root of 144 is 12.",
        }

        lower_msg = user_message.lower()
        for key, fb in fallback_answers.items():
            if key in lower_msg:
                answer = fb
                break
        else:
            answer = "Sorry, I don’t have that info right now, but I can suggest alternatives."

    return {"answer": answer}
